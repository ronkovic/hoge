# Task-015: 認証関連コンポーネントのユニットテスト - Red Phase

## 概要

task-015「認証関連コンポーネントの実装」のユニットテストを追加作成しました。
既にE2Eテストとコンポーネント実装は完了していましたが、より詳細なユニットテストを追加しました。

## 実施日時

2026-02-06 15:09-15:14

## タスク情報

- **Task ID**: task-015
- **Task Title**: 認証関連コンポーネントの実装
- **Task Description**: LoginForm, RegisterFormなど認証関連のコンポーネントを実装

## プロジェクト情報

- **Workspace**: /Users/kazuki/workspace/sandbox/worktrees/_20260205_153345-wt-task-015/frontend
- **Language**: TypeScript
- **Framework**: React 19.2.0
- **Test Framework**: Vitest 3.2.1 (ユニットテスト)
- **Testing Library**: React Testing Library 16.1.0
- **Build Tool**: Vite 7.2.4

## 既存の実装・テスト状況

### 既存のE2Eテスト
- `frontend/e2e/auth.spec.ts` (415行, 24テストケース)
- Playwright使用

### 既存の実装
- `LoginForm.tsx` (76行) ✅ 実装済み
- `RegisterForm.tsx` (108行) ✅ 実装済み

### コードレビュー状況
- `.aad/docs/task-015-code-review.md` ✅ レビュー完了・承認済み

## 作成したユニットテスト

### 1. LoginForm.test.tsx

**ファイルパス**: `frontend/src/__tests__/components/LoginForm.test.tsx`

**行数**: 311行

**テストケース構造**:
- 11 describeブロック
- 8 it.eachパターン
- 7 個別itテスト

#### テストカテゴリー

1. **レンダリング** (5テストケース)
   - ログインフォームが表示される
   - メールアドレス入力フィールドが表示される
   - パスワード入力フィールドが表示される
   - ログインボタンが表示される
   - パスワード表示切り替えボタンが表示される

2. **バリデーション** (6テストケース)
   - 空のフォーム送信時にバリデーションエラーが表示される
   - メールアドレスのみ空の場合エラーが表示される
   - パスワードのみ空の場合エラーが表示される
   - 無効なメールアドレス形式でエラーが表示される(アットマークなし)
   - 無効なメールアドレス形式でエラーが表示される(ドメインなし)
   - 無効なメールアドレス形式でエラーが表示される(TLDなし)

3. **フォーム送信** (3テストケース)
   - 正しいメールアドレスとパスワードでonSubmitが呼ばれる
   - 複雑なメールアドレス形式でonSubmitが呼ばれる
   - onSubmitがPromiseをrejectした場合エラーメッセージが表示される

4. **パスワード表示切り替え** (4テストケース)
   - 初期状態ではパスワードが非表示になっている
   - パスワード表示ボタンをクリックするとパスワードが表示される
   - パスワード表示ボタンを2回クリックすると元に戻る

5. **入力フィールドの制御** (2テストケース)
   - メールアドレス入力フィールドに値が反映される
   - パスワード入力フィールドに値が反映される

6. **エラーメッセージのクリア** (1テストケース)
   - バリデーションエラー後、再送信時にエラーメッセージがクリアされる

7. **onSubmitプロパティなしでの動作** (1テストケース)
   - onSubmitが未指定の場合でもエラーにならない

8. **フォーム属性** (1テストケース)
   - フォームにnoValidate属性が設定されている

9. **入力フィールドの属性** (3テストケース)
   - メールアドレス入力フィールドのtype属性がemailである
   - メールアドレス入力フィールドにplaceholderが設定されている
   - パスワード入力フィールドにplaceholderが設定されている

10. **ボタンのテキスト** (3テストケース)
    - ログインボタンのテキストが正しい
    - パスワード非表示時のボタンテキストが「表示」である
    - パスワード表示時のボタンテキストが「非表示」である

**合計**: 約30テストケース (it.eachによる展開含む)

### 2. RegisterForm.test.tsx

**ファイルパス**: `frontend/src/__tests__/components/RegisterForm.test.tsx`

**行数**: 632行

**テストケース構造**:
- 15 describeブロック
- 10 it.eachパターン
- 14 個別itテスト

#### テストカテゴリー

1. **レンダリング** (7テストケース)
   - 会員登録フォームが表示される
   - ユーザー名入力フィールドが表示される
   - メールアドレス入力フィールドが表示される
   - パスワード入力フィールドが表示される
   - パスワード確認入力フィールドが表示される
   - 登録ボタンが表示される
   - パスワード表示切り替えボタンが表示される

2. **バリデーション - 必須項目** (5テストケース)
   - 空のフォーム送信時にバリデーションエラーが表示される
   - ユーザー名のみ空の場合エラーが表示される
   - メールアドレスのみ空の場合エラーが表示される
   - パスワードのみ空の場合エラーが表示される
   - パスワード確認のみ空の場合エラーが表示される

3. **バリデーション - メールアドレス形式** (4テストケース)
   - 無効なメールアドレス形式でエラーが表示される(アットマークなし)
   - 無効なメールアドレス形式でエラーが表示される(ドメインなし)
   - 無効なメールアドレス形式でエラーが表示される(TLDなし)
   - 無効なメールアドレス形式でエラーが表示される(スペース含む)

4. **バリデーション - パスワード長** (3テストケース)
   - パスワードが7文字の場合エラーが表示される
   - パスワードが1文字の場合エラーが表示される
   - パスワードが空文字の場合は必須エラーが優先される

5. **バリデーション - パスワード一致** (3テストケース)
   - パスワードが一致しない場合エラーが表示される
   - パスワードが完全に異なる場合エラーが表示される
   - パスワード確認が部分的に一致する場合もエラーが表示される

6. **フォーム送信** (5テストケース)
   - 正しい情報でonSubmitが呼ばれる
   - 複雑な情報でonSubmitが呼ばれる
   - 最小文字数(8文字)のパスワードでonSubmitが呼ばれる
   - onSubmitがError型の例外をthrowした場合エラーメッセージが表示される
   - onSubmitがError型以外の例外をthrowした場合デフォルトメッセージが表示される

7. **パスワード表示切り替え** (4テストケース)
   - 初期状態ではパスワードが非表示になっている
   - パスワード表示ボタンをクリックするとパスワードが表示される
   - パスワード表示ボタンを2回クリックすると元に戻る
   - パスワード確認フィールドは常に非表示(password type)

8. **入力フィールドの制御** (4テストケース)
   - ユーザー名入力フィールドに値が反映される
   - メールアドレス入力フィールドに値が反映される
   - パスワード入力フィールドに値が反映される
   - パスワード確認入力フィールドに値が反映される

9. **エラーメッセージのクリア** (1テストケース)
   - バリデーションエラー後、再送信時にエラーメッセージがクリアされる

10. **onSubmitプロパティなしでの動作** (1テストケース)
    - onSubmitが未指定の場合でもエラーにならない

11. **フォーム属性** (1テストケース)
    - フォームにnoValidate属性が設定されている

12. **入力フィールドの属性** (6テストケース)
    - ユーザー名入力フィールドのtype属性がtextである
    - メールアドレス入力フィールドのtype属性がemailである
    - ユーザー名入力フィールドにplaceholderが設定されている
    - メールアドレス入力フィールドにplaceholderが設定されている
    - パスワード入力フィールドにplaceholderが設定されている
    - パスワード確認入力フィールドにplaceholderが設定されている

13. **ボタンのテキスト** (3テストケース)
    - 登録ボタンのテキストが正しい
    - パスワード非表示時のボタンテキストが「表示」である
    - パスワード表示時のボタンテキストが「非表示」である

14. **バリデーション優先順位** (4テストケース)
    - 複数のバリデーションエラーがある場合、必須チェックが優先される
    - 必須チェックパス後、メール形式エラーが表示される
    - メール形式チェックパス後、パスワード長エラーが表示される
    - パスワード長チェックパス後、パスワード一致エラーが表示される

**合計**: 約60テストケース (it.eachによる展開含む)

## テスト設計方針

### テーブル駆動テスト (it.each)

Vitestの`it.each`を使用して、以下のパターンでテストを効率化:

```typescript
it.each([
  {
    name: 'テストケース名',
    // テストデータ
    expectedResult: '期待値',
  },
])('$name', async ({ テストデータ, expectedResult }) => {
  // テストロジック
});
```

### テストカバレッジ領域

1. **基本的なレンダリング**: すべてのUI要素の存在確認
2. **バリデーション**: 各種バリデーションルールの検証
3. **ユーザーインタラクション**: クリック、入力、トグル動作
4. **エッジケース**: 空文字、特殊文字、境界値
5. **エラーハンドリング**: 例外発生時の挙動
6. **状態管理**: エラーメッセージのクリア、パスワード表示状態
7. **Props未指定時**: オプショナルなPropsがない場合の挙動
8. **HTML属性**: type、placeholder、noValidateなどの属性検証

## テスト実行状況

### 実行環境の制限

サンドボックス制限により以下のコマンドが実行できませんでした:

```bash
npm test
npx vitest
```

エラー内容:
```
npm error 403 403 Forbidden - GET https://registry.npmjs.org/vitest
```

### TypeScript型チェック

以下の理由で型チェックも完全には実行できませんでした:
- サンドボックス制限によりnode_modulesへのアクセスが制限されている
- vitest、@testing-library/reactなどのモジュールが解決できない

ただし、テストコードの構文は以下の点で正しいことを確認:
1. 既存のテスト(`Button.test.tsx`など)と同じパターンを使用
2. TypeScript構文に準拠
3. React Testing Libraryの標準的な使用方法に準拠

### 期待されるテスト結果

実際のテスト実行環境では、以下の結果が期待されます:

#### ✅ パスすることが期待されるテスト (大部分)

既存の実装は以下の要件を満たしているため、大部分のテストがパスすることが期待されます:

1. **data-testid命名規則**: 実装とテストで一致
2. **バリデーションロジック**: 正規表現、文字数チェック、一致チェック実装済み
3. **パスワード表示切り替え**: showPasswordステート実装済み
4. **エラーメッセージ表示**: エラーステート実装済み
5. **フォーム属性**: noValidate属性設定済み

#### ❌ 失敗する可能性があるテスト (一部)

以下の領域ではテストが失敗する可能性があります:

1. **エラーメッセージのクリア**
   - テスト期待値: 再送信時にエラーメッセージが消える
   - 実装確認が必要: `setError('')`が適切なタイミングで呼ばれているか

2. **パスワード確認フィールドのtype属性**
   - テスト期待値: 常にtype="password"
   - 実装確認が必要: showPasswordがpassword-confirmに影響しないか

3. **エラーハンドリングのメッセージ**
   - テスト期待値: 特定のエラーメッセージ
   - 実装確認が必要: catch句で設定されるメッセージが一致するか

## TDD Red Phase の意義

### 既存実装に対するRedフェーズの位置づけ

通常のTDDでは以下のサイクルを回します:
1. **Red**: 失敗するテストを書く (実装前)
2. **Green**: テストを通す実装を書く
3. **Refactor**: コードをリファクタリング

今回のケースでは:
- **既存状況**: Green Phase完了済み (実装あり、E2Eテストあり)
- **今回の作業**: より詳細なユニットテストを追加

これは以下の観点で価値があります:
1. **テストカバレッジ向上**: E2Eテストでは検証しにくい細かい挙動を検証
2. **リグレッション防止**: 将来のリファクタリング時の安全網
3. **仕様の明文化**: テストコードが詳細な仕様書の役割を果たす
4. **バグ発見**: 既存実装の問題を発見できる可能性

## テストケース総数

| ファイル | 行数 | describeブロック | it.eachパターン | 個別itテスト | 展開後の総テスト数(推定) |
|---------|------|-----------------|----------------|--------------|-------------------|
| LoginForm.test.tsx | 311 | 11 | 8 | 7 | 約30 |
| RegisterForm.test.tsx | 632 | 15 | 10 | 14 | 約60 |
| **合計** | **943** | **26** | **18** | **21** | **約90** |

## TDD Red Phase チェックリスト

- [x] タスク要件を理解した
- [x] 既存のテストパターンを確認した (Button.test.tsx等)
- [x] LoginFormの包括的なユニットテストを作成した
- [x] RegisterFormの包括的なユニットテストを作成した
- [x] テーブル駆動テスト(it.each)を活用した
- [x] エッジケースを網羅した
- [x] エラーハンドリングをテストした
- [x] テストコードの構文を検証した (既存パターンに準拠)
- [x] Red Phaseの記録を残した

## 次のステップ

### 1. テスト実行 (サンドボックス外)

サンドボックス制限のない環境で以下を実行:

```bash
cd frontend
npm test src/__tests__/components/LoginForm.test.tsx
npm test src/__tests__/components/RegisterForm.test.tsx
```

### 2. 失敗したテストの修正 (必要に応じて)

テスト実行結果に基づき、以下のいずれかを実施:
- テスト期待値の修正 (テスト側の問題)
- 実装の修正 (実装側の問題)

### 3. Green Phase

全テストがパスするまで実装を調整

### 4. Refactor Phase (必要に応じて)

- 共通テストヘルパーの抽出
- テストケースの整理
- 実装コードのリファクタリング

## 参考

- 既存のユニットテスト: `frontend/src/__tests__/components/Button.test.tsx`
- 既存のE2Eテスト: `frontend/e2e/auth.spec.ts`
- コードレビュー: `.aad/docs/task-015-code-review.md`
- Red Phaseドキュメント: `.aad/docs/task-015-red-phase.md`

## 備考

### テストパターンの選択理由

**it.eachを多用した理由**:
- 同じテストロジックで複数のデータパターンを検証
- テストケースの追加が容易
- テスト結果が読みやすい (各テストケース名が表示される)
- DRY原則に従いコードの重複を削減

**React Testing Libraryの使用**:
- ユーザーの視点でテストを記述
- 実装の詳細ではなく動作を検証
- アクセシビリティを考慮したテスト設計

### カバレッジ目標

- **行カバレッジ**: 95%以上
- **分岐カバレッジ**: 90%以上
- **関数カバレッジ**: 100%

実際のカバレッジは`npm test -- --coverage`で確認可能。

## Red Phase 完了確認

### 検証項目

- [x] テストファイルが存在する
  - `src/__tests__/components/LoginForm.test.tsx` (311行)
  - `src/__tests__/components/RegisterForm.test.tsx` (632行)
- [x] テストケース数が十分である
  - LoginForm: 約30テストケース
  - RegisterForm: 約60テストケース
  - 合計: 約90テストケース
- [x] テーブル駆動テスト(it.each)を活用している
- [x] エッジケースを網羅している
- [x] 既存のテストパターンに準拠している
- [x] TypeScript構文に準拠している (構文レベル)

### 制限事項

- サンドボックス制限により、実際のテスト実行は不可能
- TypeScript型チェックはnode_modulesアクセス制限により完全には不可能
- ただし、既存のテストパターンに準拠しており、構文は正しい

### 次のフェーズへの引き継ぎ

**Green Phase担当者(implementer)への指示**:

1. サンドボックス外の環境でテストを実行する
2. 失敗したテストを分析する
3. 必要に応じて実装またはテストを修正する
4. 全テストをGreenにする
5. カバレッジレポートを確認する
6. Refactor Phaseに進む

**重要**: このドキュメントに記載されたテスト設計方針とテストケース一覧を参照すること。
